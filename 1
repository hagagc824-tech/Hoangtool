const TelegramBot = require('node-telegram-bot-api');
const fs = require('fs');
const express = require('express');
const cors = require('cors');

const BOT_TOKEN = '8594279956:AAGZQDQVnoBaGmURmY11uKE68-9Dd0rd5Lk';
const bot = new TelegramBot(BOT_TOKEN, { polling: { interval: 300, autoStart: true } });
const app = express();
app.use(cors(), express.json());

const DB_FILE = 'data.json';
let db = { users: {}, logs: [] };
if (fs.existsSync(DB_FILE)) db = JSON.parse(fs.readFileSync(DB_FILE));

const save = () => fs.writeFileSync(DB_FILE, JSON.stringify(db, null, 2));

// Xá»­ lÃ½ tin nháº¯n nhÃ³m & bot riÃªng
bot.on('message', (msg) => {
    try {
        const cid = msg.chat.id;
        const text = msg.text || "";
        const user = msg.from.username || "KhÃ¡ch";

        // Ghi log
        db.logs.push({ time: new Date().toLocaleTimeString(), user, msg: text });
        if(db.logs.length > 50) db.logs.shift();
        save();

        // 1. Auto-delete & KÃ­ch hoáº¡t Key
        if (text.startsWith('KEY-')) {
            bot.deleteMessage(cid, msg.message_id).catch(() => {});
            db.users[msg.from.id] = { exp: Date.now() + 86400000 };
            save();
            bot.sendMessage(cid, `âœ… @${user} Ä‘Ã£ kÃ­ch hoáº¡t VIP!`);
            return;
        }

        // 2. Dá»± Ä‘oÃ¡n cáº§u (KhÃ´ng cáº§n lá»‡nh)
        if (/^[a-f0-9]{32}$/i.test(text) || /^[txTX\-\s]{3,}$/.test(text)) {
            if (!db.users[msg.from.id] || (db.users[msg.from.id].exp !== 0 && Date.now() > db.users[msg.from.id].exp)) {
                return bot.sendMessage(cid, "ðŸš« Nháº­p KEY Ä‘á»ƒ kÃ­ch hoáº¡t bot!");
            }
            const kq = Math.random() > 0.5 ? "TÃ€I" : "Xá»ˆU";
            bot.sendMessage(cid, `ðŸŽ° Káº¿t quáº£: *${kq}*\nðŸ“ MÃ£: ${text.slice(0, 6)}`, {parse_mode: 'Markdown'});
        }
    } catch (e) { console.error("Lá»—i tin nháº¯n:", e); }
});

app.get('/get-logs', (req, res) => res.json(db.logs));
app.listen(process.env.PORT || 3000, () => console.log('Server Ä‘Ã£ sáºµn sÃ ng.'));
